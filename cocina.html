<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cocina</title>
<link rel="manifest" href="manifest.json">
<style>
  body{margin:0;background:#0e1420;color:#e8eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #223049;background:#0f1522}
  h1{font-size:16px;margin:0 8px 0 0}
  .btn{background:#223049;border:1px solid #2b3b59;color:#e8eef7;padding:8px 12px;border-radius:8px;cursor:pointer}
  main{padding:14px;max-width:1100px;margin:0 auto}
  .cols{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
  @media (max-width:1100px){ .cols{grid-template-columns:1fr}}
  .col{border:1px solid #2b3b59;border-radius:12px;padding:10px}
  .col h3{margin:0 0 10px 0}
  .card{border:1px solid #2b3b59;border-radius:10px;padding:10px;margin:8px 0;background:#0f1929}
  .meta{color:#9fb2ce;font-size:12px;margin-bottom:6px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px;border-bottom:1px solid #223049;text-align:left}
  .right{text-align:right}
  .actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;margin-top:8px}
  .tag{display:inline-block;background:#2a3a5a;border-radius:999px;padding:2px 8px;margin-left:6px;font-size:11px}
  .pill{display:inline-block;background:#223049;border:1px solid #2b3b59;border-radius:999px;padding:2px 8px;font-size:11px;margin-left:6px}
  .noteBox{margin:6px 0;padding:6px;border:1px dashed #f9d95b;color:#f9d95b;border-radius:8px;font-style:italic;white-space:pre-wrap;}
</style>
</head>
<body>
<header>
  <h1>üì£ Cocina</h1>
  <div style="margin-left:auto;display:flex;gap:8px">
    <button id="btnRefrescar" class="btn">Refrescar</button>
    <a class="btn" href="admin.html">Admin</a>
    <a class="btn" href="mozo.html">Mozo</a>
  </div>
</header>

<main>
  <div class="cols">
    <div class="col">
      <h3>Pendientes <span class="pill" id="cntPend">0</span></h3>
      <div id="colPend"></div>
    </div>
    <div class="col">
      <h3>En preparaci√≥n <span class="pill" id="cntPrep">0</span></h3>
      <div id="colPrep"></div>
    </div>
    <div class="col">
      <h3>Listos <span class="pill" id="cntListo">0</span></h3>
      <div id="colListo"></div>
    </div>
  </div>
</main>

<script>
  // === CONFIGUR√Å TU SERVER IGUAL QUE EN ADMIN/MOZO ===
  const SERVER_HOST = localStorage.getItem('restopos_server_host') || location.hostname || 'localhost';
  const SERVER_PORT = Number(localStorage.getItem('restopos_server_port') || 3002);
  const SERVER = `${location.protocol}//${SERVER_HOST}:${SERVER_PORT}`;
  const api = (p, opt={}) => fetch(SERVER + p, Object.assign({headers:{'Content-Type':'application/json'}}, opt));

  // Helpers
  const $ = s => document.querySelector(s);
  function money(n){ return '$ '+(n/100).toFixed(2); }

  // --- CARD DE PEDIDO ---
  function cardHTML(o){
    const rows = (o.items||[]).map(it=>`<tr><td>${it.cant} x ${it.nombre}</td><td class="right">${money(it.precio*it.cant)}</td></tr>`).join('');
    const nota = (o.nota && String(o.nota).trim())
      ? `<div class="noteBox">üìù ${o.nota}</div>`
      : '';
    return `
      <div class="card" data-id="${o.id}">
        <div class="meta">
          Mesa ${o.mesa ?? '-'} ¬∑ ${o.mozo || '-'} ¬∑ ${new Date(o.inicio).toLocaleTimeString()}
          <span class="tag">${o.tipo||''}</span>
          <span class="tag">Total ${money((o.total)||0)}</span>
        </div>
        ${nota}
        <table><tbody>${rows}</tbody></table>
        <div class="actions">
          <button class="btn act-print">Imprimir</button>
          <button class="btn act-pend">Pendiente</button>
          <button class="btn act-prep">En prep</button>
          <button class="btn act-listo">Listo</button>
          <button class="btn act-entregado">Entregado</button>
        </div>
      </div>`;
  }

  // --- CARGA DE PEDIDOS ABIERTOS ---
  async function fetchOpenOrders(){
    const r = await api('/api/orders?estado=abierto');
    const j = await r.json().catch(()=>({orders:[]}));
    return (j.orders||[]).map(o=>{
      o.workflow = o.workflow || 'pendiente';
      o.total = o.total || (o.items||[]).reduce((a,b)=>a + (b.precio||0)*(b.cant||0),0);
      o.nota = o.nota || '';
      return o;
    });
  }

  async function setWorkflow(id, workflow){
    const r = await api(`/api/orders/${id}/status`, {
      method:'POST',
      body: JSON.stringify({ patch:{ workflow } })
    });
    if (!r.ok) {
      const t = await r.text(); alert('No se pudo actualizar: ' + t); return false;
    }
    return true;
  }

  // --- IMPRESI√ìN ---
  function printCocina(o){
    const w=window.open('','_blank','width=400,height=600');
    const rows=(o.items||[]).map(it=>`<div>${it.cant} x ${it.nombre}</div>`).join('');
    const fecha=new Date(o.cierre||o.inicio).toLocaleString();
    const nota = (o.nota && String(o.nota).trim())
      ? `<div class="muted" style="margin:6px 0;white-space:pre-wrap;border:1px dashed #666;padding:4px">üìù ${o.nota}</div>`
      : '';
    w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Comanda</title>
    <style>@page{size:80mm auto;margin:5mm}body{font:12px/1.3 -apple-system,Segoe UI,Roboto,Arial}.muted{color:#666}</style></head><body>
    <div>Mesa: ${o.mesa??'-'} ¬∑ Mozo: ${o.mozo||'-'}</div>
    ${nota}
    <hr>${rows}<hr><div class="muted">${fecha}</div>
    <script>window.print(); setTimeout(()=>window.close(), 300);<\/script>
    </body></html>`);
    w.document.close();
  }

  // --- RENDER DE COLUMNAS ---
  async function render(){
    const list = await fetchOpenOrders();
    const pend = list.filter(o=>o.workflow==='pendiente');
    const prep = list.filter(o=>o.workflow==='enprep');
    const listo = list.filter(o=>o.workflow==='listo');

    $('#colPend').innerHTML = pend.map(cardHTML).join('');
    $('#colPrep').innerHTML = prep.map(cardHTML).join('');
    $('#colListo').innerHTML = listo.map(cardHTML).join('');
    $('#cntPend').textContent = pend.length;
    $('#cntPrep').textContent = prep.length;
    $('#cntListo').textContent = listo.length;

    // botones de acci√≥n
    document.querySelectorAll('.card').forEach(card=>{
      const id = Number(card.dataset.id);
      const data = list.find(o=>o.id===id);
      card.querySelector('.act-print').onclick = ()=> printCocina(data);
      card.querySelector('.act-pend').onclick  = async()=>{ await setWorkflow(id,'pendiente'); render(); };
      card.querySelector('.act-prep').onclick  = async()=>{ await setWorkflow(id,'enprep'); render(); };
      card.querySelector('.act-listo').onclick = async()=>{ await setWorkflow(id,'listo'); render(); };
      card.querySelector('.act-entregado').onclick = async()=>{ await setWorkflow(id,'entregado'); render(); };
    });
  }

  // bot√≥n refrescar
  document.getElementById('btnRefrescar').onclick = render;

  // SSE: refresco en vivo
  try{
    const es = new EventSource(SERVER + '/api/events');
    es.addEventListener('orders_changed', render);
    es.addEventListener('order_workflow', render);
    es.addEventListener('order_closed', render);
    es.addEventListener('hello', e=>console.log('SSE cocina ok', e.data));
    es.onerror = ()=>console.warn('SSE desconectado‚Ä¶');
  }catch(e){ console.warn('SSE no disponible', e); }

  // boot
  render();
</script>
</body>
</html>
